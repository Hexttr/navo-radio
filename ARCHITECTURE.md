# NAVO RADIO — Архитектура бэкенда

## Обзор

Онлайн-радио с круглосуточным эфиром: музыка (восточная, Таджикистан) + врезки новостей, погоды и подкастов по расписанию (время Москвы).

---

## Расписание (МСК)

| Время (МСК) | Содержимое |
|-------------|------------|
| :00 каждого часа | **Аудиозаставка** (jingle.mp3 — название радио) |
| 9, 12, 15, 18, 21 | **Новости** (Таджикистан, Душанбе) |
| 10, 14, 17, 20 | **Прогноз погоды** (Душанбе) |
| 11, 16, 19, 22 | **Подкасты** (1.mp3, 2.mp3, 3.mp3, 4.mp4 по кругу) |
| Остальное время | **Музыка** + DJ-интро перед каждым треком |

---

## Источники данных

### Музыка
- **Jamendo API** — https://api.jamendo.com/v3.0/tracks
- Нужен `client_id` (регистрация: https://devportal.jamendo.com)
- Поиск по тегам: `world`, `folk`, `ethnic`, `oriental` (проверить доступные теги в API)

### Новости
- **ASIA-Plus RSS** — https://asiaplustj.info/en/rss (независимое агентство, Душанбе)
- Альтернатива: WorldNewsAPI, NewsData.io (платные, но с фильтром по стране `tj`)

### Погода
- **WeatherAPI.com** — бесплатный тариф, Душанбе (lat=38.54, lon=68.78)
- Альтернатива: OpenWeatherMap

### AI (Groq)
- Генерация текста: DJ-интро, сценарий новостей, сценарий погоды

### TTS
- **По умолчанию**: Edge TTS (бесплатно, русский голос)
- **Опционально**: ElevenLabs (лучшее качество)

---

## Архитектура системы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         NAVO RADIO Backend                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────┐                                                    │
│  │   Scheduler      │  ← Время Москвы (Europe/Moscow)                    │
│  │   (node-cron)    │                                                    │
│  └────────┬─────────┘                                                    │
│           │                                                              │
│           ▼                                                              │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                    Content Router                                  │   │
│  │  • 9,12,15,18,21 → News Block                                      │   │
│  │  • 10,14,17,20   → Weather Block                                   │   │
│  │  • 11,16,19,22   → Podcast Block (1→2→3→4→1...)                    │   │
│  │  • Иначе         → Music Block (DJ intro + Track)                  │   │
│  └────────┬─────────────────────────────────────────────────────────┘   │
│           │                                                              │
│           ▼                                                              │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                    Content Generators                              │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │   │
│  │  │ Jamendo API │ │ Groq API    │ │ Edge TTS /  │ │ RSS Parser  │  │   │
│  │  │ (треки)     │ │ (тексты)    │ │ ElevenLabs  │ │ (новости)   │  │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│           │                                                              │
│           ▼                                                              │
│  ┌──────────────────┐     ┌──────────────────┐                         │
│  │ FFmpeg           │────▶│ Icecast          │────▶ Стрим для клиентов │
│  │ (конкатенация    │     │ (HTTP stream)    │                         │
│  │  аудио)          │     │                  │                         │   │
│  └──────────────────┘     └──────────────────┘                         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  Frontend: online-radio-page/public/radio.html                           │
│  Подключается к: http://localhost:8000/stream (или ваш Icecast URL)     │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Технологический стек

| Компонент | Технология | Причина |
|-----------|------------|---------|
| Backend | **Node.js** или **Python** | Node — если хотите один язык с фронтом; Python — проще для edge-tts, Groq SDK |
| Планировщик | node-cron (Node) / schedule (Python) | Проверка времени Москвы каждую минуту |
| Стриминг | **Icecast** + **FFmpeg** | Стандарт, легко переносится Windows → Ubuntu |
| TTS | edge-tts (Python) / edge-tts (Node через child_process) | Edge TTS — только Python, в Node можно вызывать как subprocess |

**Рекомендация**: **Python** — edge-tts нативно, Groq SDK есть, проще скрипты для FFmpeg.

---

## Структура проекта

```
Radio4/
├── online-radio-page/          # Фронтенд (уже есть)
│   └── public/
│       └── radio.html
├── backend/                    # Бэкенд
│   ├── .env                    # API ключи (НЕ коммитить!)
│   ├── requirements.txt
│   ├── main.py                 # Точка входа, планировщик
│   ├── config.py               # Конфиг, время Москвы
│   ├── services/
│   │   ├── jamendo.py          # Загрузка треков
│   │   ├── groq_client.py      # AI-генерация текстов
│   │   ├── tts.py              # Edge TTS / ElevenLabs
│   │   ├── news.py             # RSS + Groq → сценарий новостей
│   │   ├── weather.py          # Weather API + Groq → сценарий погоды
│   │   └── streamer.py         # FFmpeg → Icecast
│   └── scheduler.py            # Логика расписания
├── podcasts/                   # Подкасты 1.mp3, 2.mp3, 3.mp3, 4.mp4
├── cache/                      # Кэш: сгенерированные TTS, загруженные треки
├── ARCHITECTURE.md             # Этот файл
└── README.md
```

---

## Поток данных (пример: музыкальный блок)

1. **Scheduler** решает: сейчас музыка.
2. **Jamendo** → получить следующий трек (очередь, теги world/folk).
3. **Groq** → сгенерировать 2–3 фразы про исполнителя/трек на русском.
4. **TTS** → озвучить текст → `intro.mp3`.
5. **FFmpeg** → `concat intro.mp3 + track.mp3` → отправить в Icecast.
6. Повторить после окончания трека.

---

## Переменные окружения (.env)

```env
# Moscow time — используется для расписания
TZ=Europe/Moscow

# Jamendo (нужна регистрация на devportal.jamendo.com)
JAMENDO_CLIENT_ID=your_client_id

# Groq
GROQ_API_KEY=your_groq_key

# TTS
TTS_PROVIDER=edge          # edge | elevenlabs
ELEVENLABS_API_KEY=...     # если elevenlabs

# Weather
WEATHER_API_KEY=...        # WeatherAPI.com

# Icecast
ICECAST_HOST=localhost
ICECAST_PORT=8000
ICECAST_MOUNT=/stream
ICECAST_PASSWORD=...
```

---

## Переносимость Windows → Ubuntu

| Действие | Windows | Ubuntu |
|----------|---------|--------|
| Python | python.org или winget | `apt install python3 python3-pip` |
| FFmpeg | Скачать с ffmpeg.org | `apt install ffmpeg` |
| Icecast | Скачать с icecast.org | `apt install icecast2` |
| Запуск | `python main.py` | То же + systemd для автозапуска |

Конфиг через `.env` — один и тот же на обеих платформах.

---

## С чего начать (план реализации)

### Этап 1: Базовая инфраструктура
1. Создать структуру `backend/`, `podcasts/`, `cache/`
2. Добавить `.env.example` (без секретов)
3. Реализовать `config.py` — загрузка .env, время Москвы
4. Реализовать `scheduler.py` — проверка "что играть сейчас?" по расписанию

### Этап 2: Музыкальный блок
5. **Jamendo** — получить client_id, реализовать `jamendo.py` (поиск треков по тегам)
6. **Groq** — `groq_client.py` (промпт: "Напиши 2-3 фразы для радиоведущего про трек X исполнителя Y")
7. **TTS** — `tts.py` (Edge TTS по умолчанию)
8. **Streamer** — `streamer.py` (FFmpeg concat + push в Icecast)

### Этап 3: Врезки
9. **Новости** — парсинг ASIA-Plus RSS, Groq для сценария, TTS
10. **Погода** — WeatherAPI, Groq для сценария, TTS
11. **Подкасты** — чтение из `podcasts/1.mp3` и т.д. по расписанию

### Этап 4: Интеграция и тесты
12. Установить Icecast, запустить backend
13. Подключить `radio.html` к стриму
14. Проверить расписание вручную (сдвинуть время для теста)

---

## Важные замечания

1. **API ключи** — хранить только в `.env`, добавить `.env` в `.gitignore`
2. **Jamendo** — в ответе от api.jamendo.com была ошибка "Invalid Client Id" — нужна регистрация на https://devportal.jamendo.com
3. **Подкаст 4.mp4** — FFmpeg умеет извлекать аудио из MP4
4. **Резерв** — если Jamendo/Groq/TTS недоступны, иметь fallback: тишина или заранее заготовленные фразы

---

## Альтернатива: без Icecast

Если не хотите ставить Icecast, можно:
- Генерировать **HLS-плейлист** (`.m3u8` + `.ts` сегменты) и раздавать через простой HTTP-сервер
- Или использовать **Node.js** с пакетом `icecast` для создания outbound-соединения к внешнему Icecast (например, бесплатный zeno.fm)

Для максимальной простоты — **Icecast локально** остаётся самым прямым вариантом.
