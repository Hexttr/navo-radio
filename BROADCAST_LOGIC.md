# Логика беспрерывного эфира NAVO RADIO

## Цель
Эфир 24/7 без пауз между блоками.

## Архитектура

### Поток данных
```
main loop → get_current_block() → _warmup_stream() → run_block() → enqueue_track()
                                                         ↓
                                              _stream_queue (max 16)
                                                         ↓
                                              feeder thread → FFmpeg → Icecast
```

### Расписание (московское время)
| Время | Блок |
|-------|------|
| :00 каждого часа | JINGLE (один раз) |
| 9, 12, 15, 18, 21 | NEWS |
| 10, 14, 17, 20 | WEATHER |
| 11, 16, 19, 22 | PODCAST (1–4.mp3) |
| Остальное | MUSIC |

## Устранённые проблемы

### 1. Queue full, drop
- **Причина:** Очередь 4, длинный подкаст + тишина каждые 8 сек → переполнение.
- **Решение:** Очередь 16, `_keep_stream_alive` с `block=False` — не блокирует при переполнении.

### 2. Пауза между блоками (sleep 10 сек)
- **Причина:** После JINGLE/NEWS/WEATHER/PODCAST — `sleep(10)`. Jingle ~5–10 сек. Очередь пустела → эфир молчал.
- **Решение:** Перед `sleep(5)` подкладываем тишину (8 сек), чтобы покрыть паузу до следующей проверки.

### 3. Пауза во время генерации NEWS/WEATHER
- **Причина:** `run_news_block` / `run_weather_block` — fetch RSS/API + Groq + TTS = 15–30 сек. Warmup давал 1 jingle/silence (8 сек).
- **Решение:** Для NEWS/WEATHER warmup — jingle + 2 тишины (≈24 сек) на время генерации.

## Текущая логика

### Warmup (перед блоком)
- **JINGLE, PODCAST:** не нужен — мгновенный enqueue файла.
- **NEWS, WEATHER:** jingle (если есть) + 2 тишины — покрывает 15–30 сек генерации.
- **MUSIC:** jingle или 1 тишина — быстрый старт.

### Между итерациями main loop
- **MUSIC:** без sleep — сразу следующая проверка.
- **Остальные блоки:** enqueue 1 тишина → sleep(5) — эфир не молчит.

### _keep_stream_alive (внутри NEWS/WEATHER/PODCAST)
- Пока блок длится (час) — каждые 8 сек подкладывает тишину.
- `block=False` — при переполнении очереди просто пропускает.

## Рекомендации

1. **WEATHER_API_KEY** — без ключа погода «временно недоступна». Добавить в `.env`.
2. **Jingle** — короткий (5–15 сек). Положить `jingles/jingle.mp3`.
3. **Подкасты** — длинные файлы (1.mp3 и т.д.) не переполняют очередь (16 слотов).
4. **Мониторинг** — при падении Icecast/FFmpeg feeder перезапускается автоматически.
